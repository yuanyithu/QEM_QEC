## 黎曼共轭梯度上升算法在Stiefel流形上的数学本质

## 问题设定

- **目标**: 最大化一个实值函数 $f(Q)$。
- **变量**: $Q$ 是一个 $N x K$ 的复数矩阵。
- **约束**: $Q$ 必须位于Stiefel流形上，即满足 $Q^{\dagger}Q = I_K$。

---

## 第0步：初始化

1.  **选择起点 (k=0)**:
    选择一个满足约束的初始矩阵 $Q_0$。一个常用的方法是随机生成一个 $N x K$ 的矩阵 $A$，然后对其进行QR分解 $A = Q_R * R$，取其Q因子作为 $Q_0$。
    $$
    Q_0 \in \{ Q \in \mathbb{C}^{N \times K} \ | \ Q^{\dagger}Q = I_K \}
    $$

2.  **初始化搜索方向**:
    由于没有之前的步骤，初始的搜索方向就是初始点的梯度。
    - 计算 $f(Q_0)$ 在欧几里得空间中的梯度： $grad f(Q_0)$。
    - 将该梯度投影到 $Q_0$ 点的切空间，得到黎曼梯度 $g_0$。（投影公式见下一步）。
    - 初始共轭方向 $p_0$ 即为黎曼梯度 $g_0$。
    
    $$
    p_0 = g_0 = \text{Proj}_{Q_0}(\text{grad} f(Q_0))
    $$

---

## 迭代步骤 (从 k=0, 1, 2, ... 开始循环)

在每一步 $k$，我们有一个点 $Q_k$ 和一个搜索方向 $p_k$。

### 第k.1步：计算黎曼梯度 (Riemannian Gradient)

**本质**: 在欧几里得空间中，梯度是函数增长最快的方向。但在流形上，我们必须找到在“允许的方向”（即切空间内）中，函数增长最快的方向。这通过将欧几里得梯度投影到当前点 $Q_k$ 的切空间来实现。

1.  **计算欧几里得梯度**:
    像往常一样计算 $f(Q)$ 对 $Q_k$ 的导数（梯度）。我们称之为 $\nabla_Q f(Q_k)$。
    $$
    \text{grad} f(Q_k) = \nabla_Q f(Q_k)
    $$

2.  **投影到切空间**:
    $Q_k$ 点的切空间 $T_{Q_k}St(K,N)$ 是所有满足 $Q_k^{\dagger}Z + Z^{\dagger}Q_k = $$ 的矩阵 $Z 的集合。将欧几里得梯度 $\nabla_Q f(Q_k)$ 投影到这个切空间的公式为：
    $$
    g_k = \text{Proj}_{Q_k}(\nabla_Q f(Q_k)) = \nabla_Q f(Q_k) - Q_k \text{sym}(Q_k^{\dagger} \nabla_Q f(Q_k))
    $$
    其中，$sym(A) = (A + A^{\dagger})/2$ 是取矩阵 $A$ 的对称（Hermitian）部分。这个 $g_k$ 就是我们在流形上的“梯度方向”。

### 第k.2步：更新共轭方向 (Conjugate Direction)

**本质**: 和标准共轭梯度法一样，我们不直接使用新的梯度 $g_k$ 作为前进方向，而是将其与上一步的搜索方向 $p_{k-1}$ 结合。这可以防止在优化路径中出现“锯齿”现象，从而加速收敛。由于 $p_{k-1}$ 位于上一个点 $Q_{k-1}$ 的切空间，我们必须先将它“平移”到当前点 $Q_k$ 的切空间，这个操作叫做“向量输运”（Vector Transport）。

1.  **输运旧的搜索方向**:
    将上一步的搜索方向 $p_{k-1}$ 从 $T_{Q_{k-1}}St$ 平移到 $T_{Q_k}St$。一个简单有效的方法是直接将其投影到新的切空间：
    $$
    \mathcal{T}_{Q_{k-1} \to Q_k}(p_{k-1}) = \text{Proj}_{Q_k}(p_{k-1}) = p_{k-1} - Q_k \text{sym}(Q_k^{\dagger} p_{k-1})
    $$

2.  **计算 $β_k$ (共轭系数)**:
    使用Fletcher-Reeves或Polak-Ribière等公式。这里使用前者为例，但需采用黎曼内积（对于Stiefel流形，通常是 $⟨A, B⟩ = \text{real}(\text{trace}(A^{\dagger}B))$）：
    $$
    \beta_k = \frac{\langle g_k, g_k \rangle_{Q_k}}{\langle g_{k-1}, g_{k-1} \rangle_{Q_{k-1}}}
    $$

3.  **计算新的共轭方向**:
    $$
    p_k = g_k + \beta_k \mathcal{T}_{Q_{k-1} \to Q_k}(p_{k-1})
    $$

### 第k.3步：确定步长并更新位置 (Retraction)

**本质**: 我们已经有了当前位置 $Q_k$ 和一个好的前进方向 $p_k$（它在切空间内）。我们不能简单地做 $Q_k + \alpha_k p_k$，因为结果几乎肯定会偏离流形（不再满足正交归一条件）。我们需要一个“收缩”操作，它能沿着切线方向 $p_k$ 在流形上移动一段距离 $\alpha_k$，并保证落点 $Q_{k+1}$ 仍旧在流形上。

1.  **线搜索确定步长 $α_k$**:
    寻找一个合适的步长 $\alpha_k > 0$，使得 $f(Q_{k+1})$ 有足够的增长，通常使用Armijo或Wolfe准则。目标是最大化 $\phi(\alpha) = f(R_{Q_k}(\alpha p_k))$，其中 $R$ 是下面的收缩映射。

2.  **执行收缩**:
    对于Stiefel流形，一个非常高效和常用的收缩操作是基于QR分解的。
    $$
    Q_{k+1} = R_{Q_k}(\alpha_k p_k) = \text{qf}(Q_k + \alpha_k p_k)
    $$
    这里的 $qf(A)$ 表示对矩阵 $A$ 进行QR分解 $A = QR$ 后，取其正交因子 $Q$。这个操作保证了 $Q_{k+1}^{\dagger}Q_{k+1} = I_K$，即新的点一定在流形上。

### 第k.4步：循环

设置 $k = k+1$，然后返回第k.1步，直到满足收敛条件（例如，黎曼梯度的范数 $||g_k||$ 小于某个阈值）。

---

## 总结

| 步骤         | 欧几里得空间                | 黎曼流形 (Stiefel Manifold)            | 数学本质                                   |
| :----------- | :-------------------------- | :------------------------------------- | :----------------------------------------- |
| **梯度**     | $∇f(x)$                     | $g = Proj_Q(∇f(Q))$                    | 寻找流形约束下的最速上升方向               |
| **方向更新** | $p_k = g_k + β_k * p_{k-1}$ | $p_k = g_k + β_k * Transport(p_{k-1})$ | 结合历史信息加速收敛，但需先“平移”历史方向 |
| **移动**     | $x_{k+1} = x_k + α_k * p_k$ | $Q_{k+1} = Retraction(Q_k, α_k * p_k)$ | 保证移动后的新点仍然满足流形约束           |