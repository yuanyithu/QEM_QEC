# 线路与算法规划

## 数学逻辑（仅公式层面）
- **符号约定**
  - 物理比特数 \(n\)，逻辑深度 \(L\)，分块深度 \(L_{\mathrm{check}}\)（每个检测前的层数），块数 \(K = \lceil L / L_{\mathrm{check}} \rceil\)。
  - 第 \(\ell\) 层的理想 Clifford 门记为 \(\mathcal{G}_\ell\)，其 Pauli 传输表示 \(G_\ell\)。  
  - 稀疏 Pauli 噪声信道：\(\mathcal{N}_\ell(\rho) = (1-\sum_{P\in\mathcal{P}_{\le 2}} p_{\ell,P}) \rho + \sum_{P\in\mathcal{P}_{\le 2}} p_{\ell,P} P \rho P\)，其中 \(\mathcal{P}_{\le 2}\) 仅含单、双比特 Pauli。
  - 检错投影 \(\Pi_{\mathrm{det}}\)，幸存概率 \(p_{\mathrm{surv}}\)，归一化后态 \(\rho' = \Pi_{\mathrm{det}} \rho \Pi_{\mathrm{det}} / p_{\mathrm{surv}}\)。
  - PEC 近似：每个等效噪声信道 \(\mathcal{E}\) 表示为 \(\mathcal{E} = \sum_i \eta_i \mathcal{C}_i\)（\(\mathcal{C}_i\) 为可实现的 Clifford 通道），代价因子 \(\gamma = \sum_i |\eta_i|\)。

- **单层组合**
  \[
  \rho_{\ell} = \mathcal{N}_\ell \bigl( \mathcal{G}_\ell (\rho_{\ell-1}) \bigr)
  \]
  Pauli 噪声在 Clifford 作用下保持 Pauli 形式：若噪声作用在门前，等效为门后 \(\mathcal{N}'_\ell = \mathcal{G}_\ell \circ \mathcal{N}_\ell \circ \mathcal{G}_\ell^\dagger\)。

- **一个 \(L_{\mathrm{check}}\) 块的等效噪声**
  \[
  \rho_{\text{out}}^{(k)} = \Bigl( \prod_{j=1}^{L_{\mathrm{check}}} \mathcal{N}_{\ell_j}' \Bigr) \Bigl( \mathcal{G}_{\ell_{L_{\mathrm{check}}}} \circ \cdots \circ \mathcal{G}_{\ell_1} (\rho_{\text{in}}^{(k)}) \Bigr)
  \]
  通过逐层推噪声，可写成“理想 Clifford 串”后接“一层等效 Pauli 信道”：
  \[
  \rho_{\text{out}}^{(k)} = \widetilde{\mathcal{N}}^{(k)} \bigl( \mathcal{G}_{\text{blk}}^{(k)} (\rho_{\text{in}}^{(k)}) \bigr), \quad \widetilde{\mathcal{N}}^{(k)} = \prod_{j=1}^{L_{\mathrm{check}}} \mathcal{N}_{\ell_j}'.
  \]

- **检测与后选择**
  - 经过第 \(k\) 块后的态：\(\rho^{(k)}\)。  
  - 进行检测：\(p_{\mathrm{surv}}^{(k)} = \operatorname{Tr}[\Pi_{\mathrm{det}} \rho^{(k)}]\)，幸存态 \(\rho_{\mathrm{ps}}^{(k)} = \Pi_{\mathrm{det}} \rho^{(k)} \Pi_{\mathrm{det}} / p_{\mathrm{surv}}^{(k)}\)。  
  - 总幸存概率：\(P_{\mathrm{PS}} = \prod_{k=1}^K p_{\mathrm{surv}}^{(k)}\)。

- **剩余部分的 PEC**
  - 对每块等效噪声 \(\widetilde{\mathcal{N}}^{(k)}\) 做 PEC 分解：\(\widetilde{\mathcal{N}}^{(k)} = \sum_i \eta^{(k)}_i \mathcal{C}^{(k)}_i\)，代价 \(\gamma_k = \sum_i |\eta_i^{(k)}|\)。  
  - 全线路的 PEC 代价：\(\Gamma = \prod_{k=1}^K \gamma_k\)（或对未被后选择消除的块求乘积）。

- **采样复杂度（粗略）**
  - 后选择带来的放大：\(\text{Cost}_{\mathrm{PS}} \propto 1 / P_{\mathrm{PS}}\)。  
  - PEC 带来的方差放大：\(\text{Var} \sim \Gamma^2 / N\)；给定容许方差 \(\epsilon^2\)，需要样本数 \(N \approx \Gamma^2 / \epsilon^2\)。  
  - 总采样复杂度近似：\(\text{Cost}_{\text{total}} \approx \text{Cost}_{\mathrm{PS}} \times N \approx \frac{\Gamma^2}{P_{\mathrm{PS}}\, \epsilon^2}\)（需结合具体观测算符的方差常数进行修正）。

## 关于张量积结构与 \(L_{\mathrm{check}}\) 后推的兼容性
- **IBM 2022 的优势**：每层噪声写成局域张量积 \(\mathcal{N}_\ell = \bigotimes_{j \in \text{local}} \mathcal{N}_{\ell,j}\)，每个 \(\mathcal{N}_{\ell,j}\) 仅作用在 1–2 比特，可独立做 PEC，总代价为局域 \(\gamma\) 的乘积。
- **直接展开为 Pauli 求和的问题**：若把 \(\mathcal{N}_\ell\) 展开为全局 Pauli 求和，再组合多层，独立采样优势消失，\(\gamma\) 和存储都爆炸。
- **后推时的保持策略（不展开）**：
  - 对每个局域通道 \(\mathcal{N}_{\ell,j}\) 做 Clifford 共轭，更新其作用比特集合；支持沿 light-cone 可能增长，但保持在局域尺度内，且不会一步跳到全局。
  - 块末噪声表示为“局域通道的序列/电路”而非一层全局通道：\(\widetilde{\mathcal{N}}^{(k)} = \bigcirc_{t=1}^{L_{\mathrm{check}}} \bigotimes_j \mathcal{N}_{\ell_t,j}'\)。我们按时间顺序依次应用这些局域通道并为每个做 PEC 采样，整体依旧是局域 \(\gamma\) 的乘积。
  - 若某局域通道在共轭后支持变大（沿 light-cone 扩展），其 \(\gamma\) 可能增大；通过限制 \(L_{\mathrm{check}}\) 和门布局（低度图、颜色分层）来控制支持增长。
- **必要时的近似/折中**：
  - 在支持超过阈值时，做“最近张量积近似”：将通道投影/拟合为同支持大小的张量积形式，忽略交叉项并记录截断误差上界（可用 diamond-范数或保守概率界）。
  - 采用双轨：小规模 n 使用精确 Pauli 展开验证；大规模使用张量化近似，评估截断对 \(P_{\mathrm{PS}}\) 和 \(\Gamma\) 的敏感度。
  - 调整 \(L_{\mathrm{check}}\) 或插入更频繁的检测，以防 light-cone 过度扩散导致局域性丧失。
- **对模拟程序的影响**
  - `push_noise_block` 返回“按时间序的局域通道列表”而非单一 Pauli 求和；每个元素携带支持集合与局域 Kraus/Pauli 参数。
  - `pec_decompose` 在局域上运行，输出每个局域 \(\gamma_j\)，全局 \(\gamma = \prod_j \gamma_j\)。
  - 复杂度评估时，需根据支持增长模型（light-cone）估计 \(\gamma\) 的放大和张量化近似误差对总复杂度的贡献。

## 数值与程序设计规划
- **总体流程**
  1. 输入：\(n, L, L_{\mathrm{check}}\)、每层 Clifford 门列表、每层稀疏 Pauli 噪声参数 \(\{p_{\ell,P}\}\)、检测算符 \(\Pi_{\mathrm{det}}\)（或稳定子描述）、目标观测算符 \(O\)。  
  2. 按块推进：循环块 \(k=1\ldots K\)，在块内逐层将 Pauli 噪声 conjugate 到块末尾，累积成 \(\widetilde{\mathcal{N}}^{(k)}\)；同时得到块的理想 Clifford 串 \(\mathcal{G}_{\text{blk}}^{(k)}\)。  
  3. 检测：对块输出态计算 \(p_{\mathrm{surv}}^{(k)}\) 并做归一化，更新累积幸存概率。  
  4. 对幸存的块等效噪声做 PEC 分解，得到 \(\gamma_k\) 与可采样的 Clifford 列表。  
  5. Monte Carlo 采样：按 PEC 权重与后选择成功条件，对观测 \(O\) 估计期望，并输出总样本需求。

- **数据结构建议**
  - 噪声存储：层索引 \(\ell \mapsto\) 稀疏表 `dict[Pauli_string] -> prob`，仅单/双比特项。  
  - Pauli 传输：用稳定子表（binary symplectic）或 PTM（局部稀疏，限制支持大小），便于 \(P \mapsto \pm P'\) 的快速更新。  
  - 检测：用稳定子/投影的生成元；幸存概率可由 Pauli 展开与投影重叠计算。  
  - PEC：存储 \(\eta_i^{(k)}\)、对应 Clifford 通道与权重符号，用于无偏采样。

- **文件与功能分工**
  - `protocol.py`（面向实际执行的混合算法）
    - `load_noise(layer_params)`：读取每层稀疏 Pauli 噪声参数。
    - `push_noise_block(layers)`：将一个块内的噪声推到块末尾，返回 \(\widetilde{\mathcal{N}}^{(k)}\) 与 \(\mathcal{G}_{\text{blk}}^{(k)}\)。
    - `detect_and_postselect(state, detector)`：计算 \(p_{\mathrm{surv}}^{(k)}\)，返回归一化态与概率。
    - `pec_decompose(equiv_noise)`：给出 \(\gamma_k\) 及可采样的 Clifford 列表。
    - `run_hybrid(gate_seq, noise, detector, obs, L_check)`：将以上模块串联，返回估计值与运行时统计（\(P_{\mathrm{PS}}, \Gamma, N\)）。
  - `complexity.py`（仅复杂度评估）
    - `post_selection_cost(p_surv_list)`：输出 \(P_{\mathrm{PS}}\) 与对应复杂度放大。
    - `pec_cost(gamma_list, epsilon, var_const)`：给出所需样本 \(N\) 与 PEC 方差放大。
    - `total_cost(p_surv_list, gamma_list, epsilon, var_const)`：输出总采样复杂度与敏感参数分析。
    - 选项：支持扫描 \(L_{\mathrm{check}}\)、不同噪声稀疏度、不同 Clifford 结构，评估可扩展性（特别是 \(n>6\)）。

- **算法侧的规模与近似策略**
  - 仅追踪单/双比特 Pauli 支持；若门拓展支持超出阈值，考虑丢弃小系数项或截断到固定权重 \(w_{\max}\) 以保证可扩展到更大 \(n\)。  
  - 在每个块结束前做稀疏化（合并相同 Pauli，丢弃 \(|p|<\delta\) 的项），平衡精度与规模。  
  - PEC 分解优先使用局部 Clifford 组合，避免全局支撑导致指数爆炸。

- **下一步可行动作**
  1. 明确目标门集（首选 \{H, S, CX\} 的 Clifford 生成集）与典型线路结构。  
  2. 固化检测算符表示（稳定子生成元列表）并写出 \(p_{\mathrm{surv}}\) 的计算公式。  
  3. 选定 PTM/稳定子库或自写轻量实现，验证对 \(n=6\) 的一致性，再扩展到更大 \(n\)。  
  4. 先实现 `complexity.py` 的解析公式，用现有噪声参数做扫描，给出 \(L_{\mathrm{check}}\) 的最优窗口。  
  5. 再实现 `protocol.py` 的端到端模拟，并对比复杂度估计与蒙特卡洛结果的一致性。
